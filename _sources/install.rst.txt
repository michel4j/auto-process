Installation
============

It is recommended to install AutoProcess within a python virtual environment using setuptools. Assuming you typically
install your applications in the directory `/MyApps`, you can install as follows

.. code-block:: bash

    cd /MyApps
    curl -s https://raw.githubusercontent.com/michel4j/auto-process/master/deploy/install.sh | bash


This is equivalent to running the following commands:

.. code-block:: bash

    cd /MyApps
    python3 -m venv auto-process
    source auto-process/bin/activate
    pip install --upgrade pip wheel
    pip install --upgrade mx-autoprocess


This will install AutoProcess and it's dependences within the the directory `/MyApps/auto-process`. Once installed,
AutoProcess with be available for command line based data processing. See the doc:`process` section
for information help on how to use the individual commands.


.. note::

    AutoProcess requires the following third-party packages to be properly installed and available in your path

    * XDS - http://xds.mpimf-heidelberg.mpg.de/html_doc/downloading.html
    * XDSSTAT - https://strucbio.biologie.uni-konstanz.de/xdswiki/index.php/Xdsstat
    * CCP4 - https://www.ccp4.ac.uk/
    * PHENIX - https://www.phenix-online.org/


To make the AutoProcess commands available within your shell, add `/MyApps/auto-process/bin` to your shell path.  The
following shell startup script could be used as an example:

.. code-block:: bash

    #! /usr/bin/bash

    # Format is "<host1-name>:<number of cores> <host2-name>:<number of cores> ..."
    export DPS_NODES="localhost:16"

    export DPS_PATH="/MyApps/auto-process"
    export PATH=${PATH}:$DPS_PATH/bin


Update the startup script to match your installation location. AutoProcess can submit jobs to other servers on your
local network for faster distributed processing.

Installing in a cluster environment
-----------------------------------
Update the `DPS_NODES` environment variable in your shell startup script to specify additional
compute nodes and their corresponding number of cores. Note that this will work only if (1) password-less SSH public-key
authentication is properly setup on all nodes, (2) all nodes are running ABI (application binary interface) - compatible
operating systems, (4) the same version of XDS is installed on all nodes, and (4) all nodes can access the same files
on the network using the same file system addresses.


Upgrading
=========
If a previous version of AutoProcess is already installed, then the following commands can be used to upgrade it to the latest
version.

.. code-block:: bash

    cd /MyApps
    curl -s https://raw.githubusercontent.com/michel4j/auto-process/master/deploy/upgrade.sh | bash

Which is equivalent to:

.. code-block:: bash

    cd /MyApps
    source auto-process/bin/activate
    pip install --upgrade pip wheel
    pip install --upgrade mx-autoprocess


Data Processing Server
======================
AutoProcess includes a built-in twisted server providing automated data processing from beamline data acquisition systems
such as MxDC.  The command to run the server is

.. code-block:: bash

    auto.server

However, it is preferable to start the server application from a systemd unit file or init script at startup to ensure
that the server is always available. An example unit file (`autoprocess.service`) is included in the top-level deploy directory of the archive.


.. py:currentmodule:: autoprocess.services.server

.. autoclass:: DPService
    :members:

.. py:currentmodule:: autoprocess.services.client

To use the server from an external python program, an example client class is provided in :class:`DPClient`. This client
code requires the use of a twisted reactor.

.. py:currentmodule:: autoprocess.services.client

.. autoclass:: DPClient
    :members:


Clusters
========
Installing AutoProcess in a cluster environment is recommended since XDS can run on multiple computers to
speed up the data processing. The following requirements should be satisfied in order to use AutoProcess on
multiple computers/nodes of a cluster.

1. SSH Key-Based Passwordless Authentication must be configured for each user wishing to use AutoProcess.
   If not already configured, it can be done using the following commands within a shell.


.. code-block:: bash

    ssh-keygen -t rsa -N "" -f ~/.ssh/id_rsa
    cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    chmod 600 ~/.ssh/authorized_keys


2. The operating systems and all relevant libraries on all nodes should be ABI-compatible and preferably exactly the
   same version.
3. File access and the shell environments should be identical on all nodes. This can be accomplished through network
   file systems such as NFS.
4. Finally an environment variable `DPS_NODES` must be set which describes the cluster resources available.
   The format of the envronment variable takes the form of

.. code-block:: bash

    DPS_NODES="<host1-name>:<number of cores> <host2-name>:<number of cores> ..."


