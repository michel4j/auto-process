

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Installation &mdash; AutoProcess 2020.5.25 documentation</title>
  

  
  <link rel="stylesheet" href="_static/styles.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Main Command Line Programs" href="process.html" />
    <link rel="prev" title="AutoProcess" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> AutoProcess
          

          
          </a>

          
            
            
              <div class="version">
                2020.5.25
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Setup</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="#clusters">Clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="#upgrading">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="#data-processing-server">Data Processing Server</a></li>
</ul>
<p class="caption"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="process.html">Main Command Line Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="misc.html">Miscelaneous Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="powder.html">Powder Diffraction Analysis</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">AutoProcess</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Installation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h1>
<p>It is recommended to install AutoProcess within a python virtual environment using setuptools. Assuming you typically
install your applications in the directory <cite>/MyApps</cite>, you can install as follows</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /MyApps
curl -s https://raw.githubusercontent.com/michel4j/auto-process/master/deploy/install.sh <span class="p">|</span> bash
</pre></div>
</div>
<p>This is equivalent to running the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /MyApps
python3 -m venv auto-process
<span class="nb">source</span> auto-process/bin/activate
pip install --upgrade pip wheel
pip install --upgrade mx-autoprocess
</pre></div>
</div>
<p>This will install AutoProcess and it’s dependences within the the directory <cite>/MyApps/auto-process</cite>. Once installed,
AutoProcess with be available for command line based data processing. See the doc:<cite>process</cite> section
for information help on how to use the individual commands.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>AutoProcess requires the following third-party packages to be properly installed and available in your path</p>
<ul class="simple">
<li><p>XDS - <a class="reference external" href="http://xds.mpimf-heidelberg.mpg.de/html_doc/downloading.html">http://xds.mpimf-heidelberg.mpg.de/html_doc/downloading.html</a></p></li>
<li><p>XDSSTAT - <a class="reference external" href="https://strucbio.biologie.uni-konstanz.de/xdswiki/index.php/Xdsstat">https://strucbio.biologie.uni-konstanz.de/xdswiki/index.php/Xdsstat</a></p></li>
<li><p>CCP4 - <a class="reference external" href="https://www.ccp4.ac.uk/">https://www.ccp4.ac.uk/</a></p></li>
<li><p>PHENIX - <a class="reference external" href="https://www.phenix-online.org/">https://www.phenix-online.org/</a></p></li>
</ul>
</div>
<p>To make the AutoProcess commands available within your shell, add <cite>/MyApps/auto-process/bin</cite> to your shell path.  The
following shell startup script could be used as an example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/bash</span>

<span class="c1"># Format is &quot;&lt;host1-name&gt;:&lt;number of cores&gt; &lt;host2-name&gt;:&lt;number of cores&gt; ...&quot;</span>
<span class="nb">export</span> <span class="nv">DPS_NODES</span><span class="o">=</span><span class="s2">&quot;localhost:16&quot;</span>

<span class="nb">export</span> <span class="nv">DPS_PATH</span><span class="o">=</span><span class="s2">&quot;/MyApps/auto-process&quot;</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span><span class="si">${</span><span class="nv">PATH</span><span class="si">}</span>:<span class="nv">$DPS_PATH</span>/bin
</pre></div>
</div>
<p>Update the startup script to match your installation location. AutoProcess can submit jobs to other servers on your
local network for faster distributed processing.</p>
</div>
<div class="section" id="clusters">
<h1>Clusters<a class="headerlink" href="#clusters" title="Permalink to this headline">¶</a></h1>
<p>Installing AutoProcess in a cluster environment is recommended since XDS can run on multiple computers to
speed up the data processing. The following requirements should be satisfied in order to use AutoProcess on
multiple computers/nodes of a cluster.</p>
<ol class="arabic simple">
<li><p>SSH Key-Based Passwordless Authentication must be configured for each user wishing to use AutoProcess.
If not already configured, it can be done using the following commands within a shell.</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh-keygen -t rsa -N <span class="s2">&quot;&quot;</span> -f ~/.ssh/id_rsa
cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
chmod <span class="m">600</span> ~/.ssh/authorized_keys
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>The operating systems and all relevant libraries on all nodes should be ABI-compatible and preferably exactly the
same version.</p></li>
<li><p>File access and the shell environments should be identical on all nodes. This can be accomplished through network
file systems such as NFS.</p></li>
<li><p>Finally an environment variable <cite>DPS_NODES</cite> must be set which describes the cluster resources available.
The format of the envronment variable takes the form of</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DPS_NODES</span><span class="o">=</span><span class="s2">&quot;&lt;host1-name&gt;:&lt;number of cores&gt; &lt;host2-name&gt;:&lt;number of cores&gt; ...&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="upgrading">
<h1>Upgrading<a class="headerlink" href="#upgrading" title="Permalink to this headline">¶</a></h1>
<p>If a previous version of AutoProcess is already installed, then the following commands can be used to upgrade it to the latest
version.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /MyApps
curl -s https://raw.githubusercontent.com/michel4j/auto-process/master/deploy/upgrade.sh <span class="p">|</span> bash
</pre></div>
</div>
<p>Which is equivalent to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /MyApps
<span class="nb">source</span> auto-process/bin/activate
pip install --upgrade pip wheel
pip install --upgrade mx-autoprocess
</pre></div>
</div>
</div>
<div class="section" id="data-processing-server">
<h1>Data Processing Server<a class="headerlink" href="#data-processing-server" title="Permalink to this headline">¶</a></h1>
<p>AutoProcess includes a built-in twisted server providing automated data processing from beamline data acquisition systems
such as MxDC.  The command to run the server is</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>auto.server
</pre></div>
</div>
<p>However, it is preferable to start the server application from a systemd unit file or init script at startup to ensure
that the server is always available. An example unit file (<cite>autoprocess.service</cite>) is shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>AutoProcess Server
<span class="nv">After</span><span class="o">=</span>network.target network-online.target
<span class="nv">Wants</span><span class="o">=</span>network-online.target

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">User</span><span class="o">=</span>root
<span class="nv">ExecStart</span><span class="o">=</span>auto.server
<span class="nv">Restart</span><span class="o">=</span>always

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target
</pre></div>
</div>
<p>An example Init-Script for starting the AutoProcess Server is shown below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># dpserver:   Data Processing Server</span>
<span class="c1">#</span>
<span class="c1"># chkconfig: 345 98 02</span>
<span class="c1"># description:  This is a daemon listens for data processing commands and executes them \</span>
<span class="c1">#               with the priviledges of the user requesting the action.</span>
<span class="c1">#</span>
<span class="c1"># Source function library.</span>
. /etc/rc.d/init.d/functions

<span class="c1"># Prepare environment by sourcing startup scripts for XDS, Phenix, CCP4 etc</span>
<span class="c1"># update with</span>
<span class="k">for</span> profile in /MyApps/startup/*.sh<span class="p">;</span> <span class="k">do</span>
    <span class="k">if</span> <span class="o">[</span> -r <span class="s2">&quot;</span><span class="nv">$profile</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">source</span> <span class="si">${</span><span class="nv">profile</span><span class="si">}</span>
    <span class="k">fi</span>
<span class="k">done</span>
<span class="nb">unset</span> i

<span class="c1"># services parameters</span>
<span class="nv">servicename</span><span class="o">=</span><span class="s1">&#39;dpserver&#39;</span>
<span class="nv">pidfile</span><span class="o">=</span><span class="s1">&#39;/var/run/dpserver.pid&#39;</span>
<span class="nv">logfile</span><span class="o">=</span><span class="s1">&#39;/var/log/dpserver.log&#39;</span>
<span class="nv">appfile</span><span class="o">=</span>/path/to/auto.tac
<span class="nv">umask</span><span class="o">=</span><span class="m">022</span>

<span class="nb">export</span> <span class="nv">MPLCONFIGDIR</span><span class="o">=</span>/tmp

<span class="c1"># Sanity checks.</span>
<span class="o">[</span> -f <span class="nv">$appfile</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">0</span>

start<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;Starting Data Processing Server: &quot;</span>
    daemon /usr/bin/twistd -y <span class="nv">$appfile</span> --logfile<span class="o">=</span><span class="nv">$logfile</span> --umask<span class="o">=</span><span class="nv">$umask</span> --pidfile<span class="o">=</span><span class="nv">$pidfile</span>
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> touch /var/lock/subsys/<span class="nv">$servicename</span>
<span class="o">}</span>

stop<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> -n <span class="s2">$&quot;Stopping Data Processing Server: &quot;</span>

    killproc -p <span class="nv">$pidfile</span>
    <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
    <span class="nb">echo</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$RETVAL</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        rm -f /var/lock/subsys/<span class="nv">$servicename</span>
        rm -f /var/run/<span class="nv">$pidfile</span>
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c1"># See how we were called.</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
    start<span class="o">)</span>
        start
        <span class="p">;;</span>
    stop<span class="o">)</span>
        stop
        <span class="p">;;</span>
    status<span class="o">)</span>
        status -p <span class="nv">$pidfile</span> <span class="nv">$servicename</span>
        <span class="nv">RETVAL</span><span class="o">=</span><span class="nv">$?</span>
        <span class="p">;;</span>
    restart<span class="o">)</span>
        stop
    sleep <span class="m">3</span>
        start
        <span class="p">;;</span>
    condrestart<span class="o">)</span>
        <span class="k">if</span> <span class="o">[</span> -f /var/lock/subsys/<span class="nv">$servicename</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            stop
        sleep <span class="m">3</span>
            start
        <span class="k">fi</span>
        <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="nb">echo</span> $<span class="s2">&quot;Usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|status|restart|condrestart}&quot;</span>
        <span class="p">;;</span>
<span class="k">esac</span>
<span class="nb">exit</span> <span class="nv">$RETVAL</span>
</pre></div>
</div>
<dl class="py class">
<dt id="autoprocess.services.server.DPService">
<em class="property">class </em><code class="sig-prename descclassname">autoprocess.services.server.</code><code class="sig-name descname">DPService</code><a class="headerlink" href="#autoprocess.services.server.DPService" title="Permalink to this definition">¶</a></dt>
<dd><p>Data Processing Service using Twisted Perspective Broker.</p>
<dl class="py method">
<dt id="autoprocess.services.server.DPService.analyse_frame">
<code class="sig-name descname">analyse_frame</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">frame_path</span></em>, <em class="sig-param"><span class="n">user_name</span></em>, <em class="sig-param"><span class="n">rastering</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.server.DPService.analyse_frame" title="Permalink to this definition">¶</a></dt>
<dd><p>Analyse diffraction frame</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>frame_path</strong> – full path to frame</p></li>
<li><p><strong>user_name</strong> – user name to run as</p></li>
</ul>
</dd>
<dt class="field-even">Params rastering</dt>
<dd class="field-even"><p>If True, perform scoring for rastering</p>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>a dictionary representing the processing report</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="autoprocess.services.server.DPService.process_mx">
<code class="sig-name descname">process_mx</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">info</span></em>, <em class="sig-param"><span class="n">directory</span></em>, <em class="sig-param"><span class="n">user_name</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.server.DPService.process_mx" title="Permalink to this definition">¶</a></dt>
<dd><p>Process an MX dataset</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>info</strong> – dictionary containing parameters</p></li>
<li><p><strong>directory</strong> – directory for output</p></li>
<li><p><strong>user_name</strong> – user name to run as</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>dictionary containing the report</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="autoprocess.services.server.DPService.process_xrd">
<code class="sig-name descname">process_xrd</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">info</span></em>, <em class="sig-param"><span class="n">directory</span></em>, <em class="sig-param"><span class="n">user_name</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.server.DPService.process_xrd" title="Permalink to this definition">¶</a></dt>
<dd><p>Process an XRD dataset</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>info</strong> – dictionary containing parameters</p></li>
<li><p><strong>directory</strong> – directory for output</p></li>
<li><p><strong>user_name</strong> – user name to run as</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>a dictionary of the report</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<p>To use the server from an external python program, an example client class is provided in <a class="reference internal" href="#autoprocess.services.client.DPClient" title="autoprocess.services.client.DPClient"><code class="xref py py-class docutils literal notranslate"><span class="pre">DPClient</span></code></a>. This client
code requires the use of a twisted reactor.</p>
<dl class="py class">
<dt id="autoprocess.services.client.DPClient">
<em class="property">class </em><code class="sig-prename descclassname">autoprocess.services.client.</code><code class="sig-name descname">DPClient</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">address</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.client.DPClient" title="Permalink to this definition">¶</a></dt>
<dd><p>Data Processing Server Client</p>
<dl class="py method">
<dt id="autoprocess.services.client.DPClient.analyse_frame">
<code class="sig-name descname">analyse_frame</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">frame_path</span></em>, <em class="sig-param"><span class="n">user_name</span></em>, <em class="sig-param"><span class="n">rastering</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.client.DPClient.analyse_frame" title="Permalink to this definition">¶</a></dt>
<dd><p>Analyse diffraction frame</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>frame_path</strong> – full path to frame</p></li>
<li><p><strong>user_name</strong> – user name to run as</p></li>
</ul>
</dd>
<dt class="field-even">Params rastering</dt>
<dd class="field-even"><p>If True, perform scoring for rastering</p>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>a dictionary representing the processing report</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="autoprocess.services.client.DPClient.process_mx">
<code class="sig-name descname">process_mx</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">info</span></em>, <em class="sig-param"><span class="n">directory</span></em>, <em class="sig-param"><span class="n">user_name</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.client.DPClient.process_mx" title="Permalink to this definition">¶</a></dt>
<dd><p>Process an MX dataset</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>info</strong> – dictionary containing parameters</p></li>
<li><p><strong>directory</strong> – directory for output</p></li>
<li><p><strong>user_name</strong> – user name to run as</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>dictionary containing the report</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="autoprocess.services.client.DPClient.process_xrd">
<code class="sig-name descname">process_xrd</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">info</span></em>, <em class="sig-param"><span class="n">directory</span></em>, <em class="sig-param"><span class="n">user_name</span></em><span class="sig-paren">)</span><a class="headerlink" href="#autoprocess.services.client.DPClient.process_xrd" title="Permalink to this definition">¶</a></dt>
<dd><p>Process an XRD dataset</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>info</strong> – dictionary containing parameters</p></li>
<li><p><strong>directory</strong> – directory for output</p></li>
<li><p><strong>user_name</strong> – user name to run as</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>a dictionary of the report</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="process.html" class="btn btn-neutral float-right" title="Main Command Line Programs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="AutoProcess" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2006-2020, Canadian Light Source, Inc

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>